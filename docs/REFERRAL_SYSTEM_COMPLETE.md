# TrustCart ERP — Referral System (Complete Guide)

This document explains the **full referral system** implemented in TrustCart ERP: how referral attribution is captured, how referrals are registered and completed, how rewards are credited (wallet/points/coupons/free products/VIP), how partner/influencer codes are tracked, how CRM agents can create referrals, and how admin + customer UIs interact with the backend.

> Scope: This guide documents the **actual code + migrations** currently in this workspace (NestJS backend + Next.js frontend).

---

## 1) Goals & Definitions

### 1.1 Goals

- Let a customer share a **stable referral code** and earn a reward when the referred customer’s **first delivered order** happens.
- Support **campaign-driven reward policies** (wallet/points/coupon/free product/membership).
- Support **partner attribution** (influencers/community codes) with reporting.
- Provide **CRM agent referral capture** (agent invites, creates follow-up tasks).
- Keep flows resilient (idempotent crediting, non-blocking audit logging, safe defaults).

### 1.2 Key concepts (important)

There are several “codes” in the system; they are different:

- **Share referral code (stable)**: server-driven code used for attribution and sharing.
  - Format: `REF000123` (digits only after `REF`)
  - Generated by backend from customer ID: `getShareReferralCode(customerId)`
  - Used in share links and stored on the `customers` record.

- **Referral record code (per-invite)**: `customer_referrals.referral_code`
  - Format: `REF{customerId}{RANDOM}` (example: `REF12ABCD3`)
  - Created when a referrer “invites” someone directly (or when agent creates referral).

- **Partner code**: influencer/community code stored in `referral_partners.code`.
  - Example: `NILOY10`
  - If a user signs up with this code, it’s treated as **partner attribution**, not as a customer-to-customer share code.

- **Offer/Coupon code**: applied at checkout and evaluated by the offer engine.
  - Stored in `sales_orders.offer_code`
  - Validated via `POST /offers/evaluate`.

---

## 2) Data Model (Tables & Columns)

The referral system spans multiple tables.

### 2.1 `customers` referral attribution columns

Added by migration: `backend/migrations/2026-01-12_referral_backbone_and_automation.sql`

- `customers.referred_by_customer_id` (int, nullable)
- `customers.referred_by_code` (varchar, nullable)
- `customers.referred_by_partner_id` (uuid, nullable)
- `customers.referred_channel` (varchar, nullable)
- `customers.referred_at` (timestamp, nullable)
- `customers.referral_campaign_id` (uuid, nullable)

**Meaning**
- If customer signed up using another customer’s share code: `referred_by_customer_id` is set.
- If customer signed up using a partner code: `referred_by_partner_id` is set.
- `referred_by_code` stores whichever code was used.
- `referral_campaign_id` ties signup to a campaign (currently default campaign resolution is used).

### 2.2 `customer_referrals`

Entity: `backend/src/modules/loyalty/entities/customer-referral.entity.ts`

Core fields:
- `referrer_customer_id` (int)
- `referred_customer_id` (int, nullable)
- `referred_email`, `referred_phone` (nullable)
- `referral_code` (unique)
- `status`: `pending | registered | completed | expired`

Attribution & tracking fields:
- `share_code_used` (varchar, nullable)
- `source_channel` (varchar, nullable)
- `campaign_id` (uuid, nullable)
- `partner_id` (uuid, nullable)
- `agent_user_id` (int, nullable)
- `qualifying_order_id` (int, nullable)

Reward fields:
- `reward_amount` (referrer amount)
- `reward_credited` (bool)
- `referred_reward_amount` (referred amount)
- `referred_reward_credited` (bool)

Constraints:
- Unique index to prevent multiple referrers per referred customer:
  - `uq_customer_referrals_referred_customer_id ON customer_referrals(referred_customer_id) WHERE referred_customer_id IS NOT NULL`

### 2.3 `referral_campaigns`

Created/extended by:
- `backend/migrations/2026-01-12_referral_backbone_and_automation.sql`
- `backend/migrations/2026-01-12_referral_campaign_rewards_and_coupons.sql`

Key fields:
- `id` (uuid)
- `name`
- `is_active`
- `reward_type`: `wallet | points | coupon | free_product | membership`
- Wallet rewards: `reward_referrer_amount`, `reward_referred_amount`
- Points rewards: `reward_referrer_points`, `reward_referred_points`
- Coupon/free product rewards:
  - `referrer_offer_id` (int)
  - `referred_offer_id` (int)
- VIP automation:
  - `vip_referrals_threshold` (int)
  - `vip_membership_tier` (`silver|gold|permanent`)
- Optional window: `starts_at`, `ends_at`

A default campaign is auto-inserted by migration:
- `Default Referral Campaign`

### 2.4 `referral_partners`

Created by `backend/migrations/2026-01-12_referral_backbone_and_automation.sql`

- `id` (uuid)
- `code` (unique)
- `partner_type` (e.g. `influencer`, `community`, etc.)
- `name` (nullable)
- `is_active` (bool)

### 2.5 `referral_events`

Created by `backend/migrations/2026-01-12_referral_backbone_and_automation.sql`

Append-only audit log used for reporting and automation traces.

Fields:
- `event_type` (e.g. `registered`, `completed`, `invited`, `partner_attributed`, `whatsapp_referral_nudge`, `reward_issued_coupon`, etc.)
- `referral_id`, `referrer_customer_id`, `referred_customer_id`, `order_id`
- `share_code_used`, `partner_code`, `source_channel`
- `payload` (jsonb)
- `created_at`

Important behavior: the app uses best-effort logging (`recordReferralEvent` never blocks main flows).

### 2.6 Offers-related tables

Used for coupon/free product referral rewards.

- `offer_codes` is extended to support customer-assigned codes:
  - `assigned_customer_id`, `max_uses_per_customer`, `valid_from`, `valid_to`

### 2.7 Orders and offer metadata

`sales_orders` is extended by migration:
- `discount_amount` (decimal)
- `offer_id` (int)
- `offer_code` (varchar)

These fields enable discount reporting and help partner reports include total discounts.

---

## 3) End-to-End Flows

### 3.1 Share link capture (frontend)

Two supported entry points:

1) **Direct share link**
- Link format: `/register?ref=REF000123`
- On the register page, the `ref` query param is captured.

2) **Offline landing route**
- Link format: `/r/REF000123`
- This page stores the code then redirects to `/register?ref=...`.

Implementation:
- Landing page: `frontend/src/pages/r/[code].tsx`
- Local storage utility: `frontend/src/utils/referralAttribution.ts`

Stored payload:
```json
{
  "code": "REF000123",
  "channel": "share_link" | "qr" | "checkout" | "web" | "...",
  "capturedAt": "2026-01-12T...Z"
}
```

### 3.2 Registration (frontend → backend)

When a customer registers, frontend sends:
- `ref` (the referral/share/partner code)
- `referralChannel` (source like `share_link`, `web`, etc.)

Examples:
- `frontend/src/pages/register.tsx`
- `frontend/src/pages/customer/register.tsx`

Backend handling:
- `POST /customers` in `backend/src/modules/customers/customers.service.ts`

What happens on backend:

1) Normalize `ref` and `referralChannel`.
2) Determine whether `ref` is:
   - a **partner code** (exists in `referral_partners`), or
   - a **share referral code** (matches `REF(\d+)` and parses to referrer customer ID).
3) Persist attribution onto `customers`:
   - For partner: sets `referred_by_partner_id`, `referred_by_code`, `referred_channel`, `referred_at`, `referral_campaign_id`.
   - For share code: sets `referred_by_customer_id`, `referred_by_code`, `referred_channel`, `referred_at`, `referral_campaign_id`.

4) If share code → create a `customer_referrals` row (status = `registered`) using:
   - `LoyaltyService.registerReferralFromShareCode(...)`

5) If partner code → write `referral_events` (`partner_attributed`) for analytics.

Guest-to-account upgrade path:
- If customer already exists by phone and was a guest, the backend upgrades them and still preserves referral attribution if it was not set.

### 3.3 Guest checkout (frontend → backend)

During checkout, if the shopper is not logged in:

- Frontend looks up customer by phone/email.
- If not found, it creates a customer via `POST /customers` and attaches referral attribution from localStorage.

Implementation:
- Checkout flow: `frontend/src/pages/checkout.tsx`

This ensures referrals can still be captured for guests who directly check out.

### 3.4 Completing the referral (delivered order)

Referrals are completed when the referred customer gets their **first delivered order**.

Backend trigger points:
- When a sales order is updated to `status=delivered`:
  - `backend/src/modules/sales/sales.service.ts` calls:
    - `loyaltyService.autoCompleteReferralForDeliveredOrder({ orderId, customerId })`
    - `whatsAppService.sendReferralNudgeOnDeliveredOrder({ orderId, customerId })`
- When courier status transitions to delivered:
  - `backend/src/modules/sales/order-management.service.ts` does the same.

Fraud/abuse guard:
- `autoCompleteReferralForDeliveredOrder` checks delivered order count and only completes on the **first delivered order**.

### 3.5 Reward crediting logic

When referral completes (`markReferralComplete`), reward crediting happens via:

- **Primary path**: DB trigger `credit_referral_reward()` (optional migration-based trigger)
- **Fallback path**: application logic `ensureReferralRewardCredited(referralId)` (idempotent)

Reward types:

1) **Wallet** (`reward_type = wallet`)
- Credits `wallet_transactions` + updates `customer_wallets` balance.
- Supports both-side rewards:
  - Referrer gets `reward_amount` / campaign referrer amount
  - Referred gets `referred_reward_amount` / campaign referred amount

2) **Points** (`reward_type = points`)
- Adds `point_transactions` for both parties (if configured).
- Uses idempotency keys per referral/side:
  - `referral:{id}:referrer:points`
  - `referral:{id}:referred:points`

3) **Coupon / Free product** (`reward_type = coupon` or `free_product`)
- Issues **customer-assigned single-use offer codes** using:
  - `OffersService.issueOfferCode({ offerId, assignedCustomerId, maxUses: 1, maxUsesPerCustomer: 1, ... })`
- Records audit events:
  - `reward_issued_coupon` or `reward_issued_free_product`

4) **Membership/VIP** (`reward_type = membership`)
- Reward crediting for membership is driven by the VIP rules below.

VIP automation (campaign-level):
- If `vip_referrals_threshold` is set, system checks completed referrals and upgrades membership tier via:
  - `updateMembershipTierV2(customerId, tier)`

---

## 4) Partner / Influencer Attribution

### 4.1 Partner attribution at signup

If `ref` matches an active row in `referral_partners`, backend:
- Sets partner attribution columns on `customers`
- Logs an event `partner_attributed` in `referral_events`

### 4.2 Partner reporting

Endpoint:
- `GET /loyalty/referral-partners/:code/report`

Report includes:
- Funnel counts from `referral_events` (invited/registered/completed/etc.)
- Revenue and total discount from `sales_orders` referenced by `referral_events.order_id`
- Recent attributed orders list

Admin UI:
- `frontend/src/pages/admin/loyalty/referrals/partners.tsx`

Note: Attribution in reporting is based on `referral_events.partner_code`.

---

## 5) CRM Agent Referral Capture

Agents can create a referral on behalf of a customer and automatically generate a follow-up task.

Endpoints (JWT protected):
- `POST /crm/referrals/agent`
- `GET /crm/referrals/my?limit=100`

Implementation:
- Controller: `backend/src/modules/crm/crm-referrals.controller.ts`
- Service: `backend/src/modules/crm/crm-referrals.service.ts`

What happens:
1) Creates a referral via `LoyaltyService.createAgentReferral(...)`
   - Sets `source_channel = 'agent_referral'`
   - Stores `agent_user_id` and optional `partner_id` / `campaign_id`
2) Creates a CRM task via `TaskService.create(...)`
   - Title: `Referral follow-up: <phone/email>`
   - Tagging: `['referral', 'agent_referral']`

---

## 6) Offer/Coupon Codes at Checkout (Related)

Checkout supports applying an offer/coupon code:
- Frontend sends `offer_code` in the `POST /sales` payload.

Backend stores:
- `sales_orders.offer_code`
- `sales_orders.offer_id`
- `sales_orders.discount_amount`

Offer evaluation endpoints:
- `POST /offers/evaluate` (evaluate a specific code)
- `POST /offers/best` (get best auto-apply offer)

Offer code validation rules include:
- Active status
- Valid time window
- Max uses + per-customer limits
- Optional `assigned_customer_id` enforcement (used by referral-issued codes)

---

## 7) WhatsApp Automation (Delivered-order nudge)

When an order becomes delivered, the system may send a WhatsApp “refer & earn” nudge.

Implementation:
- `backend/src/modules/messaging/whatsapp.service.ts`
- Triggered by delivered transition in sales/order-management services.

Environment variables:
- `WHATSAPP_AUTOMATION_ENABLED=true|false`
- `WHATSAPP_PROVIDER=meta_cloud|none`
- `WHATSAPP_CLOUD_API_TOKEN=...` (Meta Cloud)
- `WHATSAPP_CLOUD_PHONE_NUMBER_ID=...` (Meta Cloud)
- `APP_PUBLIC_URL=http://your-frontend-host` (used to build share URL `/r/{code}`)

Behavior:
- Builds share code via `getShareReferralCode(customerId)`
- Builds link: `${APP_PUBLIC_URL}/r/${code}`
- Sends message (Bangla) and logs event `whatsapp_referral_nudge` in `referral_events`.

Safe defaults:
- If disabled or provider is unknown, it does nothing.
- Missing credentials throw inside the service, but callers swallow errors so order flows never break.

---

## 8) API Reference (Referral-Related)

### 8.1 Loyalty referral endpoints

Controller: `backend/src/modules/loyalty/loyalty.controller.ts`

Customer-to-customer referrals:
- `POST /loyalty/referral` (JWT)
  - Body: `{ referrerCustomerId, referredEmail, referredPhone? }`
- `GET /loyalty/referrals/:customerId` (JWT)
- `GET /loyalty/referral-code/:customerId` (JWT)
  - Returns stable share code: `{ referralCode: "REF000123" }`
- `PUT /loyalty/referral/:referralId/complete` (JWT)
  - Body: `{ referredCustomerId?, orderId? }`
- `GET /loyalty/referrals/:customerId/stats` (JWT)

Admin campaigns:
- `GET /loyalty/referral-campaigns?includeInactive=true|false`
- `POST /loyalty/referral-campaigns`
- `PUT /loyalty/referral-campaigns/:id`

Admin partners:
- `GET /loyalty/referral-partners?includeInactive=true|false`
- `POST /loyalty/referral-partners`
- `PUT /loyalty/referral-partners/:id`
- `GET /loyalty/referral-partners/:code/report?from=&to=&limit=`

### 8.2 CRM agent referral endpoints

Controller: `backend/src/modules/crm/crm-referrals.controller.ts`

- `POST /crm/referrals/agent` (JWT)
  - Body:
    ```json
    {
      "referrerCustomerId": 123,
      "referredPhone": "01...",
      "referredEmail": "...",
      "notes": "...",
      "campaignId": "uuid (optional)",
      "partnerId": "uuid (optional)"
    }
    ```
- `GET /crm/referrals/my?limit=100` (JWT)

### 8.3 Offers endpoints (for referral-issued coupons/free products)

Controller: `backend/src/modules/offers/offers.controller.ts`

- `POST /offers/evaluate` with `code`
- `POST /offers/best` with optional `code`

---

## 9) Frontend Pages & Admin Navigation

### 9.1 Customer-facing referral page

- Customer referrals dashboard:
  - `frontend/src/pages/customer/referrals.tsx`
  - Shows stats + referral list + share actions.

### 9.2 Referral landing & registration

- Landing: `frontend/src/pages/r/[code].tsx`
- Registration capture:
  - `frontend/src/pages/register.tsx`
  - `frontend/src/pages/customer/register.tsx`

### 9.3 Admin pages

- Referral hub: `frontend/src/pages/admin/loyalty/referrals.tsx`
- Campaign management: `frontend/src/pages/admin/loyalty/referrals/campaigns.tsx`
- Partner management + report: `frontend/src/pages/admin/loyalty/referrals/partners.tsx`

Admin sidebar is wired from the admin layout (menu entries exist for Loyalty/Referrals/Campaigns/Partners).

---

## 10) Setup & Configuration

### 10.1 Apply database migrations

Run these SQL files on your Postgres database (in order):

1) `backend/migrations/2026-01-12_referral_backbone_and_automation.sql`
2) `backend/migrations/2026-01-12_referral_campaign_rewards_and_coupons.sql`

They are written to be safe to re-run (`IF NOT EXISTS` + guarded constraints).

### 10.2 Configure default campaign

The first migration inserts:
- `Default Referral Campaign`

You can later create more campaigns in admin UI or via API.

### 10.3 Configure coupon/free product rewards

To use `reward_type = coupon` or `free_product`:

1) Create an offer using the Offers system (`POST /offers` or admin offers UI if present).
2) Set `referrer_offer_id` and/or `referred_offer_id` on the referral campaign.
3) On completion, the system issues single-use codes assigned to the customer.

### 10.4 Configure WhatsApp automation

Set:
- `APP_PUBLIC_URL` (frontend base URL)
- `WHATSAPP_AUTOMATION_ENABLED=true`
- `WHATSAPP_PROVIDER=meta_cloud`
- Cloud API credentials

---

## 11) Operational Notes (Idempotency & Safety)

- Reward crediting is **idempotent** using per-referral idempotency keys.
- `recordReferralEvent` is best-effort and never breaks business flows.
- Referral completion is restricted to **first delivered order**.
- Multiple referrals to the same referred customer are blocked by a unique index.

---

## 12) Troubleshooting

### Referral not being captured

Checklist:
- Confirm the share link uses `?ref=REF000123` or `/r/REF000123`.
- Confirm frontend stored attribution (`trustcart_pending_referral` in localStorage).
- Confirm registration/checkout payload included `ref` and `referralChannel`.

### Referral captured but not completed

Checklist:
- Completion only happens on **delivered** order status.
- Ensure order status transition reaches `delivered` (either via sales update or courier update).
- Ensure referred customer has `customer_referrals.referred_customer_id` populated.

### Rewards not credited

Checklist:
- Application fallback should still credit via `ensureReferralRewardCredited`, even if SQL trigger is missing.
- Confirm campaign reward settings (wallet amount / points / offer IDs).
- For coupons/free products, confirm the offer exists and is active.

### Partner report looks empty

Checklist:
- Partner attribution must have written `referral_events.partner_code`.
- Report is based on `referral_events` and attributed `order_id` links.

---

## 13) Quick Verification Checklist

- Create a customer A, get share code via `GET /loyalty/referral-code/:customerId`.
- Open `/r/{code}` in incognito, register as customer B.
- Check `customers.referred_by_customer_id` for B.
- Check `customer_referrals` has a row with `status=registered`.
- Place an order as B, then transition it to `delivered`.
- Verify:
  - `customer_referrals.status=completed`
  - wallet/points/offer codes issued depending on campaign
  - optional `referral_events` entries exist

---

## 14) Where to Look in Code

Backend:
- Referral logic + rewards + campaigns/partners: `backend/src/modules/loyalty/loyalty.service.ts`
- Referral endpoints: `backend/src/modules/loyalty/loyalty.controller.ts`
- Attribution at signup: `backend/src/modules/customers/customers.service.ts`
- Delivered-order triggers: `backend/src/modules/sales/sales.service.ts`, `backend/src/modules/sales/order-management.service.ts`
- Offer codes (coupon/free product): `backend/src/modules/offers/offers.service.ts`
- WhatsApp automation: `backend/src/modules/messaging/whatsapp.service.ts`
- CRM agent referrals: `backend/src/modules/crm/crm-referrals.controller.ts`, `backend/src/modules/crm/crm-referrals.service.ts`

Frontend:
- Referral landing: `frontend/src/pages/r/[code].tsx`
- Referral local storage: `frontend/src/utils/referralAttribution.ts`
- Registration: `frontend/src/pages/register.tsx`, `frontend/src/pages/customer/register.tsx`
- Customer referrals dashboard: `frontend/src/pages/customer/referrals.tsx`
- Admin referral config: `frontend/src/pages/admin/loyalty/referrals/*`

---

If you want, I can also generate a shorter “Quick Start” version of this doc (1–2 pages) for operational teams, and keep this file as the engineering reference.